# Health Management (Sensor Fusion, Risk Reasoning)

운동/활동 중 **열 환경(온도·습도)**, **공기질(가스 농도 PPM)**, **심박 신호**를 동시에 수집하고, **센서 노이즈를 억제한 뒤 위험도를 상황별로 판단**하여 “휴식/열 관리/호흡 관리/정상”을 안내하는 실시간 헬스 모니터링 시스템입니다 [1][3].  
단순 임계값 경보가 아니라, **센서 파싱 → EKF 기반 상태추정 → 3-Way Heuristics(Trend/Pattern/Spike) → Adaptive Threshold**로 이어지는 “알고리즘 중심 파이프라인”을 설계한 것이 핵심입니다 [1][3].

그리고 이제 하드웨어 구성 설명도 추가하며누좋을 것 같아 위치는 내가 복사 붙여넣기할께 하드웨어 구성 파트만 작성해줘

## 하드웨어 구성

이 시스템은 **Arduino 기반 엣지 디바이스**에서 센서 신호를 직접 수집·처리하고, 위험 판정 결과를 **LED로 즉시 피드백**하며, 동시에 **Wi‑Fi로 서버에 데이터를 전송**하는 구조로 설계되었습니다 [1][2].

- **MCU 보드(Arduino UNO 계열)**: 센서 데이터 수집 및 EKF/위험 판정 로직을 수행하는 메인 컨트롤러입니다 [1][3].  
- **온·습도 센서(2개 구성)**: 열 환경(온도·습도)을 측정하고 Heat Index/Trend 산출에 사용됩니다 [3][1].  
- **공기질 센서(아날로그 입력)**: 가스 농도 추정에 필요한 신호를 입력받아 PPM 기반 공기질 지표를 구성합니다 [1][2].  
- **심박동 센서(아날로그 입력)**: 심박 파형을 입력받아 필터링된 심박 신호로 활용합니다 [1][2].  
- **LED 알림(2개)**: 위험 유형에 따라 표시되는 상태 출력 장치입니다(열 관리/호흡 관리 등 상태 구분) [3][2].  
- **Wi‑Fi 통신 모듈(보드 내 Wi‑Fi 사용)**: 실시간 주기로 서버에 HTTP POST 방식으로 센서/판정 데이터를 전송합니다 [1][3].  
- **전원 구성**: 배터리 기반 구동 구성이 포함되어 이동형(웨어러블/현장형) 프로토타입 형태로 제시됩니다 [3].  

### 핀/인터페이스 개요(자료 기반)

- **아날로그 입력**: 공기질 센서, 심박동 센서 신호 입력에 사용됩니다 [1][2].  
- **디지털 출력**: LED 알림 출력에 사용됩니다 [1][2].  
- **Wi‑Fi 네트워크 연결**: 보드에서 직접 네트워크에 접속하여 서버로 데이터를 전송합니다 [3][2].

## 입력 신호 (범용 센서 표기)

- **온·습도 센서**: 온도/습도를 기반으로 **Heat Index(체감온도)**를 산출하고 열 위험 평가에 사용합니다 [1][3].  
- **공기질 센서**: 아날로그 신호를 **가스 농도(PPM)**로 정량화하여 호흡 위험 지표로 사용합니다 [1][3].  
- **심박동 센서**: 아날로그 심박 파형을 필터링해 변동을 줄이고 안정적인 입력으로 사용합니다 [2][3].

## 핵심 기술 1: 센서 파싱(정량화) + 상태 표현

이 시스템은 “Raw 센서값”을 그대로 쓰지 않고, 각 신호를 **의미 있는 단위/지표**로 바꾼 뒤 알고리즘에 투입합니다 [1][3].  
온·습도는 **Heat Index Trend(체감온도 추세)**로 표현되어 열 환경이 “좋아지는지/나빠지는지”를 연속적으로 해석할 수 있게 구성되어 있습니다 [1].  
공기질은 PPM 단위의 농도 추세로 관리되며, 열 지표와 함께 위험도를 분리해 판단할 수 있도록 설계되어 있습니다 [1][3].

## 핵심 기술 2: EKF 기반 센서 융합(노이즈 억제)

자료에서는 **EKF(확장 칼만 필터)**의 예측–갱신 구조를 통해, 측정치의 흔들림을 줄이고 “현재 상태(온도/습도/공기질)”를 안정적으로 추정하는 과정을 핵심 요소로 제시합니다 [1].  
실제 로그에서도 Raw 값과 EKF 추정값이 함께 제시되며, EKF가 측정 노이즈를 누르고 더 안정적인 추정치로 수렴하는 흐름이 확인됩니다 [1].  
이 설계의 효과는, 위험 판단이 순간적인 잡음에 휘둘리지 않고 **상태 변화의 방향성과 크기**를 기반으로 동작하도록 만든다는 점입니다 [1][3].

## 핵심 기술 3: 심박 신호 필터링(HPF + LPF)

심박 신호는 센서 특성상 **저주파 드리프트(기준선 흔들림)**와 **고주파 잡음**이 섞이기 쉬워 “그대로 쓰면” 상태 판정에 불리합니다 [3].  
자료/코드에는 심박 신호를 **High-pass + Low-pass(대역통과 형태)**로 처리하는 구조가 명시되어 있으며, 이는 느린 추세성 흔들림(DC/기준선 성분)을 줄이고, 너무 빠른 잡음을 억제해 **심박 파형의 유효 대역**을 남기려는 목적의 설계로 해석됩니다 [3][2].  
즉, 심박 입력을 “측정 노이즈가 큰 신호”에서 “판단 가능한 신호”로 만드는 전처리 단계로서 필터를 사용한 것이 포인트입니다 [3].

## 핵심 기술 4: 3-Way Heuristics (시나리오 기반 위험 탐지)

자료의 위험 판단은 하나의 룰이 아니라, 아래 **3가지 시나리오**를 병렬로 고려하는 구조입니다 [1][3].

- **Trend Risk(추세 위험)**: 일정 구간의 변화량을 보고 “점진적으로 악화되는 상황”을 탐지합니다 [1][3].  
- **Pattern Risk(패턴 위험)**: 표준편차(SD) 기반으로 “평소 대비 변동성이 커진 이상 패턴”을 탐지합니다 [1][3].  
- **Spike Risk(스파이크 위험)**: Raw와 추정값의 차이를 이용해 “순간 급변”을 위험 신호로 탐지합니다 [1][3].

이 구조의 장점은 **서서히 나빠지는 케이스(Trend)**와 **불안정해지는 케이스(Pattern)**, **순간적으로 튀는 케이스(Spike)**가 서로 다른 방식으로 나타나더라도 놓치지 않도록 설계했다는 점입니다 [1][3].

## 핵심 기술 5: Adaptive Threshold (LTSD 기반 동적 임계값)

패턴 위험 탐지에서 중요한 부분은, SD를 고정 임계값으로 비교하지 않고 **LTSD(Long-Term Standard Deviation)를 EMA로 갱신**해 “평소 변동성”을 기준으로 임계값이 적응하도록 만든 점입니다 [1].  
자료에는 LTSD가 “historical SD의 EMA”로 정의되고, 이를 이용해 **Adaptive SD Threshold**를 구성하는 개념이 제시됩니다 [1].  
이 방식은 환경 변화나 센서 품질 차이로 변동폭이 달라져도, 경보가 과도하게 울리지 않도록 **안정적인 위험 탐지**를 목표로 합니다 [1][3].

## 출력(의사결정)과 효과

시스템은 센서 분석 결과를 사용자 행동으로 연결하기 위해, 결과를 **OPTIMAL / MANAGE HEAT / MANAGE BREATH / TAKE A BREAK** 형태의 명확한 메시지로 제공합니다 [1][3].  
또한 Heat Index Trend와 Gas Concentration(PPM)을 함께 보여주는 구성으로, 열 환경과 공기질 위험을 분리해서 이해할 수 있도록 설계되어 있습니다 [1].  
서버 측에서도 수신 데이터(온도·습도·가스·Heat Index·예측값·Intensity)를 로깅하는 흐름이 제시되어, “엣지에서 판단한 결과”를 서비스/대시보드로 확장할 수 있는 형태를 갖추고 있습니다 [1][2].

그럼 이번에는 지금 헬스 매니지먼트 코드에는 무수히 많은 파라미터 고정 값들이 있어 사용자가 테스트해서 조정해야하는 임계값들이 있는데 그것을 모아서 사용자가 셋팅하기 쉽도록 파라미터를 설명하는 파트를 만들어줘

아래는 README에 그대로 붙여넣을 수 있는 **“파라미터 튜닝 가이드” 섹션**입니다. (요청대로 *사용자가 테스트로 조정해야 하는 임계값/고정값*을 한곳에 모아 설명했습니다.) [1]

***

## 파라미터 튜닝 가이드 (사용자 설정용)

이 프로젝트는 센서 환경(실내/실외, 환기, 착용 상태, 전원 노이즈)에 따라 **임계값을 반드시 재튜닝**해야 합니다 [1].  
아래 파라미터들은 “무조건 정답 값”이 아니라, **오탐/미탐을 보면서 조정하는 설정값**입니다 [1].

### 위험 판정 임계값 (가장 중요)

| 파라미터 | 의미 | 값이 커지면 | 값이 작아지면 | 언제 조정? |
|---|---|---|---|---|
| `HIMAXINCREASEDELTA` | Heat Index 변화량 기반 **Trend Risk** 임계값 | Trend 경보가 늦게 뜸(둔감) | Trend 경보가 자주 뜸(민감) | 운동 강도가 높아 정상 상승이 큰 경우 ↑ [1] |
| `GMAXINCREASEDELTA` | 공기질(PPM) 변화량 기반 **Trend Risk** 임계값 | 공기질 악화 경보가 늦게 뜸 | 공기질 경보가 자주 뜸 | 실내 환기/센서 위치가 민감하면 ↑ [1] |
| `HIINNOVATIONTHRESHOLD` | Raw HI ↔ 필터 HI 차이 기반 **Spike Risk** 임계값 | 순간 튐을 덜 경고 | 순간 튐을 더 경고 | 센서가 흔들려서 스파이크가 잦으면 ↑ [1] |
| `GINNOVATIONTHRESHOLD` | Raw PPM ↔ 필터 PPM 차이 기반 **Spike Risk** 임계값 | 가스 스파이크를 덜 경고 | 가스 스파이크를 더 경고 | 공기질 센서 노이즈가 심하면 ↑ [1] |

### 패턴(변동성) 기반 임계값: Adaptive SD Threshold

| 파라미터 | 의미 | 값이 커지면 | 값이 작아지면 | 튜닝 포인트 |
|---|---|---|---|---|
| `RISKHISTORYSIZE` | Trend/Pattern 계산에 쓰는 히스토리 길이 | 더 “완만”한 판단(느려짐) | 더 “즉각” 반응(민감) | 짧으면 오탐↑, 길면 경보 지연↑ [1] |
| `SDSMOOTHINGFACTOR` | LTSD(장기 SD) 업데이트의 EMA 비율 | 최근 변화에 빨리 적응 | 장기 평균에 더 고정 | 환경이 자주 바뀌면 ↑ [1] |
| `SDSAFETYMULTIPLIER` | LTSD에 곱하는 안전 계수(패턴 임계값 여유) | 패턴 경보가 줄어듦 | 패턴 경보가 늘어남 | 오탐이 많으면 ↑, 미탐이 많으면 ↓ [1] |
| `HISDTHRESHOLD`, `GSDTHRESHOLD` | 최종 SD 임계값(내부에서 갱신됨) | - | - | 보통 직접 고정 튜닝 대상이라기보다, **동작 확인용 지표**에 가깝습니다 [1] |

### 센서 스케일/변환 관련 (환경 의존)

| 파라미터 | 의미 | 값이 커지면 | 값이 작아지면 | 언제 조정? |
|---|---|---|---|---|
| `GASMAXPPM` | 공기질 변환 범위(ADC→PPM 스케일 상한) | 변환된 PPM 값이 커질 수 있음 | PPM 값이 작게 나옴 | 센서 종류/캘리브레이션 기준이 바뀌면 재설정 [1] |
| `ADCMAX` | ADC 해상도 기준값 | - | - | 보드/ADC 설정이 달라질 때만 점검 [1] |

### 심박 신호 필터/스케일 (움직임/착용 상태에 민감)

| 파라미터 | 의미 | 값이 커지면 | 값이 작아지면 | 튜닝 포인트 |
|---|---|---|---|---|
| `FS` | 샘플링 주파수(필터 설계의 기준) | 필터 동작이 “다른 신호”로 해석될 수 있음 | 동일 | 실제 루프 주기/측정 주기와 불일치하면 반드시 수정 [1] |
| `FCHP` | 고역통과 컷오프(느린 드리프트 제거) | 저주파 성분을 더 강하게 제거 | 드리프트가 더 남음 | 착용 변화로 기준선 흔들림이 크면 ↑ [1] |
| `FCLP` | 저역통과 컷오프(고주파 잡음 제거) | 더 많은 고주파가 통과(노이즈↑) | 더 많이 평활(파형 둔화) | 노이즈가 심하면 ↓, 맥박 형태가 뭉개지면 ↑ [1] |
| `SCALINGGAIN` | 심박 신호 스케일(증폭) | 출력 진폭↑ | 출력 진폭↓ | 센서 출력이 약하면 ↑ [1] |
| `DCOFFSET` | DC 오프셋 보정 | 기준선 이동 | 기준선 이동 | ADC 중심값이 다를 때 조정 [1] |
| `PLOTMAX` | (표시용) 클램핑 상한 | 그래프 포화↑ | 포화↓ | 시각화가 잘리면 조정 [1] |

***

### 튜닝 권장 순서 (실무 팁)

1. **스파이크 임계값(`HIINNOVATIONTHRESHOLD`, `GINNOVATIONTHRESHOLD`)**부터 조정해 “센서 튐” 오탐을 먼저 잡습니다 [1].  
2. 다음으로 **Trend 임계값(`HIMAXINCREASEDELTA`, `GMAXINCREASEDELTA`)**을 조정해 정상 운동 구간에서 “휴식 경보”가 과하게 뜨지 않게 맞춥니다 [1].  
3. 마지막으로 **`RISKHISTORYSIZE` + `SDSMOOTHINGFACTOR` + `SDSAFETYMULTIPLIER`**로 패턴 경보(변동성 기반)를 환경에 맞게 안정화합니다 [1].
